<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SYSTEM TERMINAL v2.0</title>
<style>
  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: #000;
    color: #00ff41;
    font-family: 'Courier New', Courier, monospace;
    height: 100vh;
    overflow: hidden;
  }

  #matrix-canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
  }

  #chat-container {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    max-width: 720px;
    height: 100vh;
    margin: 0 auto;
    padding: 20px 16px;
  }

  #chat-header {
    border: 1px solid #00ff41;
    padding: 10px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(0, 0, 0, 0.85);
    flex-shrink: 0;
  }

  #chat-header h1 {
    font-size: 16px;
    font-weight: normal;
    letter-spacing: 2px;
  }

  #status-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: #00ff41;
  }

  #status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #00ff41;
    animation: blink 1.2s step-end infinite;
  }

  @keyframes blink {
    50% { opacity: 0; }
  }

  #messages {
    flex: 1;
    overflow-y: auto;
    border-left: 1px solid #00ff41;
    border-right: 1px solid #00ff41;
    padding: 16px;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    flex-direction: column;
    gap: 12px;
    scrollbar-width: thin;
    scrollbar-color: #00ff41 #000;
  }

  #messages::-webkit-scrollbar { width: 6px; }
  #messages::-webkit-scrollbar-track { background: #000; }
  #messages::-webkit-scrollbar-thumb { background: #00ff41; }

  .msg {
    white-space: pre-wrap;
    word-wrap: break-word;
    line-height: 1.5;
    font-size: 14px;
  }

  .msg.user { color: #00ff41; }
  .msg.user::before { content: '> '; color: #00cc33; }

  .msg.bot { color: #33ff66; opacity: 0.9; }
  .msg.bot::before { content: '[SYS] '; color: #009922; }

  .msg.system {
    color: #007711;
    font-size: 12px;
    text-align: center;
  }

  #input-bar {
    display: flex;
    align-items: center;
    border: 1px solid #00ff41;
    background: rgba(0, 0, 0, 0.9);
    padding: 0;
    flex-shrink: 0;
  }

  #input-prompt {
    padding: 12px 0 12px 16px;
    font-size: 14px;
    color: #00cc33;
    font-family: inherit;
    user-select: none;
  }

  #user-input {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: #00ff41;
    font-family: inherit;
    font-size: 14px;
    padding: 12px 8px;
    caret-color: #00ff41;
  }

  #user-input::placeholder { color: #005500; }

  #send-btn {
    background: transparent;
    border: none;
    border-left: 1px solid #00ff41;
    color: #00ff41;
    font-family: inherit;
    font-size: 14px;
    padding: 12px 20px;
    cursor: pointer;
    letter-spacing: 1px;
  }

  #send-btn:hover { background: rgba(0, 255, 65, 0.1); }
  #send-btn:active { background: rgba(0, 255, 65, 0.2); }
</style>
</head>
<body>

<canvas id="matrix-canvas"></canvas>

<div id="chat-container">
  <div id="chat-header">
    <h1>SYSTEM TERMINAL v2.0</h1>
    <div id="status-indicator">
      <div id="status-dot"></div>
      <span>ONLINE</span>
    </div>
  </div>

  <div id="messages">
    <div class="msg system">— CONNECTION ESTABLISHED —</div>
    <div class="msg bot">System ready. Enter your query.</div>
  </div>

  <div id="input-bar">
    <span id="input-prompt">&gt;&nbsp;</span>
    <input type="text" id="user-input" placeholder="Type a command..." autocomplete="off" autofocus>
    <button id="send-btn">SEND</button>
  </div>
</div>

<script>
// ============================================================
// CONFIG — Set your n8n webhook URL here
// ============================================================
const N8N_WEBHOOK_URL = ''; // e.g. 'https://your-n8n.example.com/webhook/xxxx'
// ============================================================

// --- Matrix Rain ---
(function initMatrixRain() {
  const canvas = document.getElementById('matrix-canvas');
  const ctx = canvas.getContext('2d');

  function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  resize();
  window.addEventListener('resize', resize);

  const fontSize = 14;
  let columns = Math.floor(canvas.width / fontSize);
  let drops = Array.from({ length: columns }, () => Math.random() * -50);

  const chars = 'アイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユヨラリルレロワヲン0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';

  function draw() {
    ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = '#00ff41';
    ctx.font = fontSize + 'px monospace';

    const colCount = Math.floor(canvas.width / fontSize);
    if (colCount !== columns) {
      columns = colCount;
      drops = Array.from({ length: columns }, (_, i) => drops[i] !== undefined ? drops[i] : Math.random() * -50);
    }

    for (let i = 0; i < columns; i++) {
      const char = chars[Math.floor(Math.random() * chars.length)];
      const x = i * fontSize;
      const y = drops[i] * fontSize;

      ctx.globalAlpha = 0.8 + Math.random() * 0.2;
      ctx.fillText(char, x, y);
      ctx.globalAlpha = 1;

      if (y > canvas.height && Math.random() > 0.975) {
        drops[i] = 0;
      }
      drops[i]++;
    }
  }

  setInterval(draw, 45);
})();

// --- Chat Logic ---
const messagesEl = document.getElementById('messages');
const userInput = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');

function scrollToBottom() {
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function addMessage(text, cls) {
  const div = document.createElement('div');
  div.className = 'msg ' + cls;
  div.textContent = text;
  messagesEl.appendChild(div);
  scrollToBottom();
  return div;
}

function decryptEffect(el, finalText) {
  return new Promise((resolve) => {
    const glitch = 'ABCDEFGHIJKLMNOPQRSTUVWXYZアイウエオ0123456789!@#$%&*';
    const len = finalText.length;
    let revealed = 0;
    const interval = setInterval(() => {
      let display = '';
      for (let i = 0; i < len; i++) {
        if (i < revealed) {
          display += finalText[i];
        } else {
          display += glitch[Math.floor(Math.random() * glitch.length)];
        }
      }
      el.textContent = display;
      scrollToBottom();
      revealed += Math.max(1, Math.floor(len / 20));
      if (revealed >= len) {
        clearInterval(interval);
        el.textContent = finalText;
        scrollToBottom();
        resolve();
      }
    }, 30);
  });
}

async function sendMessage() {
  const text = userInput.value.trim();
  if (!text) return;

  userInput.value = '';
  addMessage(text, 'user');

  const botEl = addMessage('DECRYPTING...', 'bot');

  let reply;
  try {
    const res = await fetch('/api/send?message=' + encodeURIComponent(text));
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    if (data.error) {
      reply = '[ERROR] ' + data.error;
    } else {
      const r = data.response;
      reply = typeof r === 'string' ? r : (r.output || r.response || r.message || r.text || JSON.stringify(r));
    }
  } catch (err) {
    reply = '[ERROR] Connection failed: ' + err.message;
  }

  await decryptEffect(botEl, reply);
}

sendBtn.addEventListener('click', sendMessage);
userInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') sendMessage();
});
</script>
</body>
</html>
